<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Booking</title>
    <style>
        /* Global Styles */
        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8fafc; /* Light gray background */
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
        }

        .container {
            width: 100%;
            max-width: 400px;
            background: white;
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* Subtle shadow */
            display: none;
        }

        .container.active {
            display: block;
        }

        .title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
            color: #1e293b; /* Dark text for contrast */
        }

        input, button, textarea {
            width: 100%;
            padding: 12px;
            margin: 8px 0;
            border: 1px solid #e2e8f0; /* Light border */
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.2s, box-shadow 0.2s;
        }

        input:focus, textarea:focus {
            outline: none;
            border-color: #6d28d9; /* Focus color */
            box-shadow: 0 0 0 3px rgba(109, 40, 217, 0.1); /* Subtle focus effect */
        }

        button {
            background-color: #6d28d9; /* Primary button color */
            color: white;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, transform 0.2s;
        }

        button:hover {
            background-color: #5b21b6; /* Darker on hover */
            transform: translateY(-1px); /* Slight lift */
        }

        .secondary {
            background-color: #f3e8ff; /* Light purple for secondary buttons */
            color: #6d28d9; /* Purple text */
        }

        .secondary:hover {
            background-color: #e9d5ff; /* Lighter on hover */
        }

        .teacher-list {
            margin-top: 10px;
        }

        .teacher-item {
            padding: 12px;
            border: 1px solid #e2e8f0; /* Light border */
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .teacher-item:hover {
            background-color: #f8fafc; /* Light hover effect */
        }

        .selected-teacher {
            font-weight: 600;
            margin-bottom: 15px;
            text-align: center;
            color: #6d28d9; /* Highlight color */
        }
    </style>
    <script type="module">
        // Import Firebase SDK
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.10/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAMLNRWLEvFzLTVDRooQ0cFky1pl5VbSHw",
            authDomain: "student-app-e7025.firebaseapp.com",
            projectId: "student-app-e7025",
            storageBucket: "student-app-e7025.appspot.com",
            messagingSenderId: "312008380132",
            appId: "1:312008380132:web:df1ae4074e0ab8d04da6f1",
            measurementId: "G-0X93M2LKQ3"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let selectedTeacher = null; // Store the selected teacher

        // Check if the user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                // User is logged in, show the search teacher view
                switchView("search-teacher");
                searchTeacher();
            } else {
                // User is not logged in, show the login view
                switchView("login");
            }
        });

        function switchView(view) {
            document.querySelectorAll(".container").forEach(div => div.classList.remove("active"));
            const targetView = document.getElementById(view);
            if (targetView) {
                targetView.classList.add("active");

                // Update the selected teacher display if applicable
                if (view === "book-appointment" || view === "send-message") {
                    const selectedTeacherElement = document.getElementById("selected-teacher");
                    if (selectedTeacherElement && selectedTeacher) {
                        selectedTeacherElement.innerText = `Selected Teacher: ${selectedTeacher.name}`;
                    }
                }
            } else {
                console.error(`Element with id "${view}" not found.`);
            }
        }

        window.handleLogin = function() {
            let email = document.getElementById("login-email").value;
            let password = document.getElementById("login-password").value;
            
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;
                    alert("Login successful!");
                    switchView("search-teacher"); // Switch to the search teacher view
                    searchTeacher(); // Fetch and display teachers
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                });
        };

        window.handleRegister = function() {
            let email = document.getElementById("register-email").value;
            let password = document.getElementById("register-password").value;
            
            createUserWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed up
                    const user = userCredential.user;
                    alert("Registration successful!");
                    switchView("search-teacher"); // Switch to the search teacher view
                    searchTeacher(); // Fetch and display teachers
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                });
        };

        window.searchTeacher = async function() {
            try {
                // Fetch teachers from Firestore
                const querySnapshot = await getDocs(collection(db, "teachers"));

                const teachers = [];
                querySnapshot.forEach((doc) => {
                    if (doc.data().name) { // Ensure the document has a 'name' field
                        teachers.push({ id: doc.id, ...doc.data() });
                    }
                });

                if (teachers.length === 0) {
                    alert("No teachers found.");
                    return;
                }

                // Display teachers in the UI
                const teacherList = document.getElementById("teachers-list");
                if (!teacherList) {
                    console.error("Element with id 'teachers-list' not found.");
                    return;
                }

                teacherList.innerHTML = ""; // Clear the list
                teachers.forEach((teacher) => {
                    const teacherItem = document.createElement("div");
                    teacherItem.className = "teacher-item";
                    teacherItem.innerText = teacher.name;
                    teacherItem.onclick = () => {
                        selectedTeacher = teacher; // Set the selected teacher
                        switchView("book-appointment"); // Switch to the book appointment view
                    };
                    teacherList.appendChild(teacherItem);
                });

                switchView("search-teacher"); // Switch to the search teacher view
            } catch (error) {
                console.error("Error fetching teachers:", error);
                alert("Error fetching teachers. Please try again.");
            }
        };

        window.bookAppointment = async function() {
            let date = document.getElementById("appointment-date").value;
            let time = document.getElementById("appointment-time").value;
            if (!date || !time) return alert("Please select a date and time");
            
            try {
                await addDoc(collection(db, "bookings"), {
                    teacher: selectedTeacher.name,
                    date,
                    time
                });
                alert("Appointment booked successfully!");
                switchView("send-message"); // Switch to the send message view
            } catch (error) {
                alert("Error booking appointment: " + error.message);
            }
        };

        window.sendMessage = async function() {
            let message = document.getElementById("message-text").value;
            if (!message) return alert("Please enter a message");
            
            try {
                await addDoc(collection(db, "messages"), {
                    message,
                    sender: auth.currentUser.email,
                    timestamp: new Date(),
                    teacher: selectedTeacher.name // Associate the message with the selected teacher
                });
                alert("Message sent successfully!");
                switchView("search-teacher"); // Switch back to the search teacher view
            } catch (error) {
                alert("Error sending message: " + error.message);
            }
        };

        // Logout functionality
        window.handleLogout = function() {
            signOut(auth)
                .then(() => {
                    alert("Logged out successfully!");
                    switchView("login"); // Redirect to the login view
                })
                .catch((error) => {
                    alert("Error logging out: " + error.message);
                });
        };

        // Add search functionality
        window.filterTeachers = function() {
            const searchTerm = document.getElementById("search-box").value.toLowerCase();
            const teacherItems = document.querySelectorAll(".teacher-item");
            teacherItems.forEach(item => {
                const teacherName = item.innerText.toLowerCase();
                if (teacherName.includes(searchTerm)) {
                    item.style.display = "block";
                } else {
                    item.style.display = "none";
                }
            });
        };
    </script>
</head>
<body>
    <!-- Register View -->
    <div id="register" class="container">
        <div class="title">Register</div>
        <input type="email" id="register-email" placeholder="Email">
        <input type="password" id="register-password" placeholder="Password">
        <button onclick="handleRegister()">Register</button>
        <button class="secondary" onclick="switchView('login')">Login</button>
    </div>

    <!-- Login View -->
    <div id="login" class="container active">
        <div class="title">Login</div>
        <input type="email" id="login-email" placeholder="Email">
        <input type="password" id="login-password" placeholder="Password">
        <button onclick="handleLogin()">Login</button>
        <button class="secondary" onclick="switchView('register')">Register</button>
    </div>

    <!-- Search Teacher View -->
    <div id="search-teacher" class="container">
        <div class="title">Search Teacher</div>
        <input type="text" id="search-box" placeholder="Search for a teacher..." oninput="filterTeachers()">
        <div id="teachers-list" class="teacher-list">
            <!-- Teachers will be dynamically added here -->
        </div>
        <button class="secondary" onclick="handleLogout()">Logout</button>
    </div>

    <!-- Book Appointment View -->
    <div id="book-appointment" class="container">
        <div class="title">Book Appointment</div>
        <div id="selected-teacher" class="selected-teacher"></div>
        <input type="date" id="appointment-date">
        <input type="time" id="appointment-time">
        <button onclick="bookAppointment()">Book Appointment</button>
        <button class="secondary" onclick="switchView('search-teacher')">Back to Search</button>
    </div>

    <!-- Send Message View -->
    <div id="send-message" class="container">
        <div class="title">Send Message</div>
        <div id="selected-teacher" class="selected-teacher"></div>
        <textarea id="message-text" placeholder="Type your message here..." rows="4"></textarea>
        <button onclick="sendMessage()">Send Message</button>
        <button class="secondary" onclick="switchView('search-teacher')">Back to Search</button>
    </div>
</body>
</html>